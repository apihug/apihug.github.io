---
title: ApiHug Spring Data Extension
description: ApiHug SDK spring data extension
---

import { TipInfo } from '@/components/Tip'

å®ç° é«˜æ•ˆç®€å•çš„ ORM æ•°æ®åº“ç®¡ç†!

1. ORM
2. Multi Tenant
3. OLAP/OLTP


## é…ç½®

é…ç½®è·¯å¾„ï¼š`hope.data`ï¼› é…ç½®å¯¹è±¡ï¼š `HopeDataProperties`

| é…ç½®                    | å¤‡æ³¨                |
|-----------------------|-------------------|
| `defaultUserIdString` | é»˜è®¤ ç”¨æˆ· ID(String)  |
| `defaultTenantString` | é»˜è®¤ ç§Ÿæˆ· ID(String)  |
| `defaultUserId`       | é»˜è®¤ ç”¨æˆ· ID(Integer) |
| `defaultTenantId`     | é»˜è®¤ ç§Ÿæˆ· ID(Integer) |

é»˜è®¤ç”¨æˆ·ID, ç§Ÿæˆ·ID åœ¨æ¶‰åŠåˆ°ï¼Œæ•°æ®è½åœ° audit éœ€è¦æ—¶ä»ä¸Šä¸‹æ–‡è·å–ï¼Œå¦‚æœªæä¾›(å¦‚éç™»å½•ç”¨æˆ·)ä½¿ç”¨æ­¤é»˜è®¤å€¼ã€‚

ç”¨æˆ·ID, ç§Ÿæˆ·IDï¼Œå€¼ç±»å‹å¿…é¡»æ˜¯ï¼š`LONG`|`STRING`|`INTEGER` ä¹‹ä¸€ã€‚

## Liquibase

`ApiHug` ä½¿ç”¨ `Liquibase` å®ç°æ•°æ®åº“Schema çš„ç‰ˆæœ¬ç®¡ç†å’Œè¿ç§»(å¼€å‘ç¯å¢ƒï¼Œçº¿ä¸Šç¯å¢ƒæš‚ä¸”æ‰‹åŠ¨ç»´æŠ¤ä¸å»ºè®®è‡ªåŠ¨åŒ–)ï¼›

[Database Initialization-Execute Liquibase Database Migrations on Startup](https://docs.spring.io/spring-boot/how-to/data-initialization.html#howto.data-initialization.migration-tool.liquibase)

é…ç½®å®Œå…¨ä½¿ç”¨ [Spring Data Migration](https://docs.spring.io/spring-boot/appendix/application-properties/index.html#appendix.application-properties.data-migration) å…³äº `spring.liquibase` éƒ¨åˆ†ï¼š

é…ç½®è·¯å¾„ `spring.liquibase`ï¼› é…ç½®å¯¹è±¡ `LiquibaseProperties`ã€‚


| é…ç½®        | å¤‡æ³¨                                   |
|-----------|--------------------------------------|
| `enabled` | Whether to enable Liquibase support. |

åŒæ—¶æœ‰ `no-liquibase` å¼ºåˆ¶ä¸å¯åŠ¨  Liquibase çš„profileè®¾ç½®ï¼›

<TipInfo>ç”Ÿäº§ç¯å¢ƒï¼Œ</TipInfo>

è¡¨ç»“æ„è¿ç§»å’Œç”Ÿæˆé…ç½®ï¼Œå‡ç”±æ¡†æ¶ stub ä»»åŠ¡ç»´æŠ¤ï¼Œ æ‰€ä»¥å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œå¯å…é…ç½®å¯åŠ¨ã€‚

## JDBC

**ApiHug** æ•´ä¸ª JDBC éƒ¨åˆ†æ˜¯å»ºç«‹åœ¨ [Spring Data JDBC](https://docs.spring.io/spring-data/relational/reference/) åŸºç¡€ä¸Šã€‚

ä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨æ›´é«˜çº§çš„ ORM æ¡†æ¶å¦‚JPA, Hibernate? åŸºäºåº”ç”¨ç¨‹åºå’Œæ•°æ®åº“å¤©ç„¶çš„å¼‚æ„æ€§ï¼Œè¿‡äºå¤æ‚çš„æ•°æ®åº“äº¤äº’(OLAP)ä¼šå‰Šå¼±æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„ç¨³å®šæ€§å’Œå¥å£®æ€§ã€‚

æ‰€ä»¥ç›´æ¥ä½¿ç”¨ JDBCï¼› ä½¿å¾—å¦‚æœé€šè¿‡JDBCè¿›è¡Œå¤æ‚çš„SQL æ“ä½œå˜å¾—éå¸¸åˆ«æ‰­å’Œéš¾å—(æˆ‘ä»¬æä¾›å¦å¤–ä¸€å¥—OLAP æ–¹æ¡ˆ)ï¼› 

æ ¸å¿ƒçš„ OLTP ç”± Spring Data Repository æä¾›éå¸¸å¥å£®ã€æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆã€‚

Spring Data å¯¹äºæ•°æ®æ“ä½œå…¶å®åªæä¾›äº† Repository æ ¸å¿ƒæ¦‚å¿µï¼Œå®ŒæˆåŸºæœ¬çš„ CRUD æ“ä½œï¼Œç®€å•è€Œåˆå¹²å‡€ã€‚

### Entity 

**ApiHug** å®ä½“å¯¹è±¡éƒ½æ˜¯é€šè¿‡ `protobuf` å®šä¹‰ï¼Œé€šè¿‡ `wire`å‘½ä»¤è½¬è¯‘ï¼Œæœ€åé€šè¿‡ `stub` åœ¨åº”ç”¨æ¨¡å—ç”Ÿæˆå®ä½“ç±»ã€‚

æ”¯æŒ  jakarta & spring annotation æ ‡æ³¨ï¼›

1. `jakarta.persistence`
2. `org.springframework.data.annotation`

ç”Ÿæˆæœ€æ ‡å‡†çš„ POJO å¯¹è±¡ï¼›

### Wire

| ç±»å             | Identify                                           |
|----------------|----------------------------------------------------|
| `ALL`          | æ”¯æŒä¸‹é¢æ‰€æœ‰åè®®                                           |
| `AUDITABLE`    | Auditable: CreatedAt,CreatedBy,UpdatedAt,UpdatedBy |
| `DELETABLE`    | Deletable: Deleted,DeletedAt,DeletedBy             | 
| `IDENTIFIABLE` | Identifiable: Id                                   | 
| `TENANTABLE`   | Tenantable:TenantId                                | 
| `VERSIONABLE`  | Versionable:Version                                | 
| `NONE`         | æ²¡æœ‰åè®®                                               |

å®šä¹‰å®ä½“æ—¶å€™å¯ä»¥æ ¹æ®éœ€è¦ï¼Œç»‡å…¥ä¸åŒçš„åè®®ï¼Œ**ApiHug** å°†è‡ªåŠ¨ä¸ºä½ åŠ å…¥é¢å¤–å±æ€§ï¼Œä¸”è‡ªåŠ¨ç»´æŠ¤è¿™äº›å€¼å¯¹è±¡ï¼›

### DSL

ORMæ¡†æ¶ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿç¼–å†™æ›´å¹²å‡€ã€æ›´ç®€æ´çš„æŒä¹…åŒ–ä»£ç å’Œé¢†åŸŸé€»è¾‘ã€‚

ç„¶è€Œï¼Œå¯¹äºORMæ¡†æ¶æ¥è¯´ï¼Œæ„å»ºæ­£ç¡®ä¸”ç±»å‹å®‰å…¨çš„æŸ¥è¯¢APIæ˜¯ä¸€ä¸ªè®¾è®¡ä¸Šçš„æŒ‘æˆ˜ã€‚

åœ¨å¹¿æ³›ä½¿ç”¨çš„Java ORMæ¡†æ¶Hibernateï¼ˆä»¥åŠä¸ä¹‹å¯†åˆ‡ç›¸å…³çš„JPAæ ‡å‡†ï¼‰ï¼Œå®ƒæå‡ºäº†ä¸€ä¸ªåŸºäºå­—ç¬¦ä¸²çš„æŸ¥è¯¢è¯­è¨€HQLï¼ˆJPQLï¼‰ï¼Œä¸SQLéå¸¸ç›¸ä¼¼ã€‚

è¿™ç§æ–¹æ³•çš„æ˜æ˜¾ç¼ºç‚¹æ˜¯ç¼ºä¹ç±»å‹å®‰å…¨æ€§å’Œé™æ€æŸ¥è¯¢æ£€æŸ¥ã€‚æ­¤å¤–ï¼Œåœ¨æ›´å¤æ‚çš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚ï¼Œå½“æŸ¥è¯¢éœ€è¦æ ¹æ®æŸäº›æ¡ä»¶åœ¨è¿è¡Œæ—¶æ„å»ºæ—¶ï¼‰ï¼Œæ„å»ºHQLæŸ¥è¯¢é€šå¸¸æ¶‰åŠåˆ°å­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œè¿™é€šå¸¸æ˜¯ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”å®¹æ˜“å‡ºé”™ã€‚

ä½ æ˜¯å¦åŒå€¦äº†åœ¨çº¿ä¸Šç¯å¢ƒæ£€æµ‹SQLè¯­æ³•é”™è¯¯ï¼Ÿ SQLè¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›å¼ºå¤§ï¼Œæ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå¹¶ä¸”å…·æœ‰ä¸°å¯Œçš„è¯­æ³•ã€‚

è€Œ **ApiHug** ä¸º SQLè®¾å®šDSLï¼Œ å¯ä»¥ä½¿ç”¨Javaç¼–è¯‘å™¨æ¥ç¼–è¯‘SQLè¯­å¥ã€å…ƒæ•°æ®å’Œæ•°æ®ç±»å‹ï¼Œ åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥SQLè¯­å¥çš„æ­£ç¡®æ€§ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œä»è€Œæé«˜å¼€å‘æ•ˆç‡å’Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚

åšåˆ°çœŸæ­£æ„ä¹‰ä¸Šçš„ **Typesafe** SQL!

**ApiHug** SQL DSL å€Ÿé‰´äº† JOOQ, Mybatis dynamic SQL, QueryDsl ç­‰è§£å†³æ–¹æ¡ˆï¼š

1. `proto` å…ƒè¯­å®ä½“è®¾è®¡
2. `annotation` å®ä½“æ ‡æ³¨
3. å®ä½“ä¼´ç”Ÿ DSL ç±»

å…¼å…·æ•ˆç‡ã€å®ç”¨å’Œå®‰å…¨ï¼

```sql
  SELECT
      SYSTEM_PLATFORM_ROLE_AUTHORITY.AUTHORITIES
  FROM
      SYSTEM_PLATFORM_ROLE_AUTHORITY
          JOIN
      SYSTEM_PLATFORM_ROLE ON SYSTEM_PLATFORM_ROLE_AUTHORITY.ROLE_ID = SYSTEM_PLATFORM_ROLE.ID
          JOIN
      SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER ON SYSTEM_PLATFORM_ROLE.ID = SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER.ROLE_ID
  WHERE
      SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER.ACCOUNT_ID = ?
```

ç­‰åŒè¡¨è¾¾å¼ï¼š

```java
 final Buildable<SelectModel> selectStatement =
        select(SYSTEM_PLATFORM_ROLE_AUTHORITY.Authorities)
            .from(SYSTEM_PLATFORM_ROLE_AUTHORITY)
            .join(
                SYSTEM_PLATFORM_ROLE,
                on(SYSTEM_PLATFORM_ROLE_AUTHORITY.RoleId, equalTo(SYSTEM_PLATFORM_ROLE.Id)))
            .join(
                SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER,
                on(SYSTEM_PLATFORM_ROLE.Id, equalTo(SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER.RoleId)))
            // Base on specific account
            .where(SYSTEM_PLATFORM_ACCOUNT_ROLE_MAPPER.AccountId, isEqualTo(accountId));
```

### Repository


Spring Data æŠ½è±¡ä¸­çš„æ ¸å¿ƒæ¥å£æ˜¯ [Repository]((https://docs.spring.io/spring-data/relational/reference/repositories/core-concepts.html))ã€‚å®ƒå°†è¦ç®¡ç†çš„é¢†åŸŸç±»ä»¥åŠé¢†åŸŸç±»çš„æ ‡è¯†ç¬¦ç±»å‹ä½œä¸ºç±»å‹å‚æ•°ã€‚è¯¥æ¥å£ä¸»è¦ä½œä¸ºä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œç”¨äºæ•è·è¦å¤„ç†çš„ç±»å‹ï¼Œå¹¶å¸®åŠ©æ‚¨å‘ç°æ‰©å±•æ­¤æ¥å£çš„å…¶ä»–æ¥å£ã€‚

> Spring Data considers domain types to be entities, more specifically aggregates. 
> So you will see the term "entity" used throughout the documentation that can be interchanged with the term "domain type" or "aggregate".
> As you might have noticed in the introduction it already hinted towards domain-driven concepts. We consider domain objects in the sense of DDD. Domain objects have identifiers (otherwise these would be identity-less value objects), and we somehow need to refer to identifiers when working with certain patterns to access data. 
> Referring to identifiers will become more meaningful as we talk about repositories and query methods.

**ApiHug** æ··åˆäº† `SimpleJdbcRepository` + DSL 

1.  `HopeJdbcRepository` ç»§æ‰¿è‡ª  `springframework.SimpleJdbcRepository` (`CrudRepository`|`PagingAndSortingRepository`|`QueryByExampleExecutor`)
2.  é€šè¿‡ `Stub` æ··å…¥ Entity DSL å®šä¹‰

ä¸€ä¸ªç®€å•çš„ `Student` å®ä½“  `Repository` å®šä¹‰ï¼š

```java
public interface StudentEntityRepository 
    extends HopeJdbc<StudentEntity>, 
            SampleJdbcSupport, 
            StudentEntityDSL, 
            ListCrudRepository<StudentEntity, Long> {
}
```

## Mybatis

ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿåœ¨æ•°æ®åº“äº¤äº’å±‚ï¼Œ é™¤äº†ä¸Šé¢è¯´çš„æ•°æ®åº“ä¸–ç•Œå’Œåº”ç”¨ç¨‹åºä¸–ç•Œå¤©ç„¶çš„å¼‚æ„ç‰¹è´¨ï¼Œå¦å¤–ä¸€ä¸ªå¢åŠ å¤æ‚åº¦å°±æ˜¯ OLTP/OLAP ä¸åˆ†ã€‚

ä¸Šé¢è¯´åˆ°**ApiHug** é‡‡ç”¨æœ€åŸå§‹çš„JDBCæ¥åš OLTP, DSL è§£å†³ç±»å‹å®‰å…¨, é‚£ä¹ˆOLAP å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

ä» DDD(é¢†åŸŸé©±åŠ¨è®¾è®¡)çš„ CQRS(å‘½ä»¤æŸ¥è¯¢è´£ä»»åˆ†ç¦»), **ApiHug** å¾—åˆ°äº†çµæ„Ÿï¼š

> CQRS æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå°†ç³»ç»Ÿçš„å‘½ä»¤ï¼ˆä¿®æ”¹æ•°æ®ï¼‰å’ŒæŸ¥è¯¢ï¼ˆè¯»å–æ•°æ®ï¼‰æ“ä½œåˆ†å¼€å¤„ç†ã€‚

æ‰€ä»¥ OLTP/OLAP å¤©ç„¶å°±åº”è¯¥åˆ†å¼€çš„ï¼Œå“ªæ€•åŸºäºåŒä¸€ä¸ªæ•°æ®æºï¼å“ªæ€•éœ€è¦é‡æ–°éƒ¨åˆ†é€»è¾‘ï¼Œ so **ApiHug** æ¨èå®è·µï¼š

1. è·¨è¡¨ç»Ÿè®¡å’ŒæŸ¥è¯¢
2. å¤æ‚çš„ç»Ÿè®¡(é™¤å•è¡¨åŸºæœ¬ç»Ÿè®¡ï¼Œsum/avg etc)

ä¸Šæ–‡çš„ DSLä¸¾ä¾‹ä»£ç å°±æ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚

æŠ€æœ¯çš„åº•åº§å‘¢?åŸºäº [mybatis-dynamic-sql](https://github.com/mybatis/mybatis-dynamic-sql)ï¼Œspringæ‰©å±• [NamedParameterJdbcTemplateExtensions](https://github.com/mybatis/mybatis-dynamic-sql/blob/master/src/main/java/org/mybatis/dynamic/sql/util/spring/NamedParameterJdbcTemplateExtensions.java)ã€‚

æ¨¡æ¿ç±»ç”Ÿæˆå‡ç”± `stub` å‘½ä»¤ç»Ÿä¸€ç”Ÿæˆï¼Œä¸šåŠ¡å±‚åªéœ€ `wire`è¿›æ¥å®ç°é€»è¾‘å°±å¯ä»¥ï¼Œæ˜¯ä¸æ˜¯å¾ˆä¾¿æ·å‘¢ï¼Ÿ

## Converter

æ¶‰åŠé `primitive` æ•°æ®ç±»å‹çš„åºåˆ—å’Œååºåˆ—åŒ–ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡ï¼Œ Enum ç±»å‹å€¼ã€‚

**å†…ç½®**:

| ç±»å                            | å¤‡æ³¨                       |
|-------------------------------|--------------------------|
| BigDecimalListReaderConverter | BigDecimal List  ååºåˆ—åŒ–    |
| BigDecimalListWriterConverter | BigDecimal List  åºåˆ—åŒ–     |
| BooleanListWriterConverter    | Boolean List  åºåˆ—åŒ–        |
| BooleanListReaderConverter    | Boolean List  ååºåˆ—åŒ–       |
| ByteListReaderConverter       | Byte List  åºåˆ—åŒ–           |
| ByteListWriterConverter       | Byte List  ååºåˆ—åŒ–          |
| DateListReaderConverter       | LocalDate List  åºåˆ—åŒ–      |
| DateListWriterConverter       | LocalDate List  ååºåˆ—åŒ–     |
| DateTimeListReaderConverter   | LocalDateTime List  åºåˆ—åŒ–  |
| DateTimeListWriterConverter   | LocalDateTime List  ååºåˆ—åŒ– |
| DoubleListReaderConverter     | Double List  åºåˆ—åŒ–         |
| DoubleListWriterConverter     | Double List  ååºåˆ—åŒ–        |
| FloatListReaderConverter      | Float List  åºåˆ—åŒ–          |
| FloatListWriterConverter      | Float List  ååºåˆ—åŒ–         |
| IntegerListReaderConverter    | Integer List  åºåˆ—åŒ–        |
| IntegerListWriterConverter    | Integer List  ååºåˆ—åŒ–       |
| LongListReaderConverter       | Long List  åºåˆ—åŒ–           |
| LongListWriterConverter       | Long List  ååºåˆ—åŒ–          |
| ShortListReaderConverter      | Short List  åºåˆ—åŒ–          |
| ShortListWriterConverter      | Short List  ååºåˆ—åŒ–         |
| StringListReaderConverter     | String List  åºåˆ—åŒ–         |
| StringListWriterConverter     | String List  ååºåˆ—åŒ–        |
| TimeListWriterConverter       | LocalTime List  åºåˆ—åŒ–      |
| TimeListReaderConverter       | LocalTime List  ååºåˆ—åŒ–     |

é™¤é¢„ç½®converterå¤–ï¼Œ ä¹Ÿå¯ä»¥è‡ªæ‰©å±•ï¼Œ é€šè¿‡ `proto` å®šä¹‰çš„ Enum å€¼ç±»å‹ï¼Œæ¡†æ¶å·²ç»å¸®ä½ é¢„ç”Ÿæˆäº†ç›¸å…³converter è‡ªåŠ¨æ³¨å†Œåˆ°ä¸Šä¸‹æ–‡äº†ï¼›

å¦‚æœ‰ä¸€ä¸ª `AccountStatusEnum` æšä¸¾ç±»å‹ï¼Œ**ApiHug** å°†è‡ªåŠ¨ç”Ÿæˆæ³¨å†Œå¦‚ä¸‹å‡ ä¸ª converter:

| ç±»å                                    | å¤‡æ³¨                               |
|---------------------------------------|----------------------------------|
| AccountStatusEnumReaderTitleConverter | AccountStatusEnum æŒ‰ç…§æ ‡é¢˜ ååºåˆ—åŒ–      |
| AccountStatusEnumWriterTitleConverter | AccountStatusEnum æŒ‰ç…§æ ‡é¢˜ ååºåˆ—åŒ–      |
| AccountStatusEnumListWriterConverter  | AccountStatusEnum List æŒ‰ç…§æ ‡é¢˜ ååºåˆ—åŒ– |
| AccountStatusEnumListReaderConverter  | AccountStatusEnum List æŒ‰ç…§æ ‡é¢˜ ååºåˆ—åŒ– |


## Pageable

é€šè¿‡ [Criteria](https://docs.spring.io/spring-data/relational/reference/jdbc/entity-persistence.html#jdbc.criteria)  + [Pageable](https://docs.spring.io/spring-data/relational/reference/repositories/query-methods-details.html#repositories.special-parameters) å®ç°åˆ†é¡µæŸ¥è¯¢ï¼š


```java
@Derived
@Query
default Page<Account> queryPlatformAccount(QueryPlatformAccountRequest request, PageRequest pageParameter) {
      Criteria criteria = EasyCriteria
                            .in(Domain.Type,Constant.AccountTypes.PLATFORM_ACCOUNT_TYPE_NAME)
                            .and(EasyCriteria.like(Domain.Name, request.getName()))
                            .and(EasyCriteria.eq(Domain.Email, request.getEmail()));
      return findAll(criteria, page(pageParameter));
}
```


## Multi Data Source

<TipInfo>To be done ğŸ—ï¸</TipInfo>


## Refer

1. [jOOQ](https://www.jooq.org/) generates Java code from your database and lets you build type safe SQL queries through its fluent API.
2. [mybatis-dynamic-sql](https://github.com/mybatis/mybatis-dynamic-sql) About SQL DSL (Domain Specific Language) for Kotlin and Java. Supports rendering for MyBatis or Spring JDBC Templates
3. [querydsl](http://querydsl.com/) Unified Queries for Java.Querydsl is compact, safe and easy to learn.
4. [Intro to Querydsl](https://www.baeldung.com/intro-to-querydsl)
5. [Spring Data Using jOOQ](https://docs.spring.io/spring-boot/reference/data/sql.html#data.sql.jooq)
